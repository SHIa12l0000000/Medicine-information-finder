<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MediDB — India (IndexedDB import + client search)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--bg:#f6fbff;--card:#fff;--muted:#666;--accent:#0b63b7}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:#0d1721}
    .wrap{max-width:1100px;margin:22px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    input[type="search"], input[type="file"], select, textarea{padding:10px;border-radius:8px;border:1px solid #ddd;font-size:14px}
    button{padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .row{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(20,30,50,0.06);flex:1;min-width:280px}
    pre{white-space:pre-wrap;overflow:auto;background:#f3f6fb;padding:10px;border-radius:6px;border:1px solid #eef;max-height:360px}
    .small{font-size:13px;color:var(--muted)}
    .result-item{padding:8px;border-bottom:1px solid #f3f4f6;cursor:pointer}
    .result-item:hover{background:#f8fbff}
    #status{margin-top:10px;color:#333}
  </style>
  <!-- Libraries from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:48px;height:48px;border-radius:10px;background:#e9f5ff;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent)">MD</div>
      <div>
        <h1>MediDB — India (Indexed import + Search)</h1>
        <div class="muted">Import CSV/JSON (official dumps from IPC/CDSCO/NPPA or vendor JSON). Data stored in your browser (IndexedDB). No data leaves your machine.</div>
      </div>
    </header>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:700">Quick steps</div>
      <ol>
        <li>Obtain medicine lists / monographs as CSV/JSON from official sources or licensed vendor. See links below.</li>
        <li>Click <strong>Choose files</strong> (you may select many files at once) and then <strong>Import files</strong>. Files are stored into IndexedDB in chunks.</li>
        <li>Use the search box to find a brand/generic/API. Click a result to view full details.</li>
      </ol>
      <div id="status" class="small">Status: ready</div>
    </div>

    <div class="controls">
      <input id="q" type="search" placeholder="Search brand / generic / api / manufacturer" style="flex:1" />
      <button id="searchBtn">Search</button>
      <select id="limitSel" title="results">
        <option value="10">Top 10</option>
        <option value="25" selected>Top 25</option>
        <option value="50">Top 50</option>
      </select>
      <input id="fileIn" type="file" accept=".json,.csv" multiple />
      <button id="importBtn">Import files</button>
      <button id="clearDbBtn" style="background:#c0392b">Clear DB</button>
    </div>

    <div class="row" style="margin-top:12px">
      <div style="flex:1;min-width:300px">
        <div class="card">
          <div class="small">Search results</div>
          <div id="results" style="max-height:420px;overflow:auto;padding:6px;border-radius:6px;border:1px solid #eee;background:#fff"></div>
        </div>
      </div>

      <div style="flex:2;min-width:360px">
        <div class="card">
          <div id="detailTitle" style="font-size:18px;font-weight:800">No record selected</div>
          <div class="small" id="detailSource">Dataset: (none)</div>
          <div style="margin-top:12px">
            <div class="k">Brand / Name</div><div class="v" id="f_brand">—</div>
            <div class="k">Generic / Salt</div><div class="v" id="f_generic">—</div>
            <div class="k">Active Ingredient (API)</div><div class="v" id="f_api">—</div>
            <div class="k">Dosage / Form</div><div class="v" id="f_form">—</div>
            <div class="k">Dosage / Administration</div><div class="v" id="f_dosage">—</div>
            <div class="k">Storage</div><div class="v" id="f_storage">—</div>
            <div class="k">Manufacturer</div><div class="v" id="f_manuf">—</div>
            <div class="k">Code / Local code</div><div class="v" id="f_code">—</div>
            <div class="k">Expiry / Shelf life</div><div class="v" id="f_expiry">—</div>
          </div>
          <div style="margin-top:12px">
            <div class="k">Raw JSON (selected)</div>
            <pre id="f_json">—</pre>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px" class="card">
      <div style="font-weight:700">Schema & tips</div>
      <div class="small" style="margin-top:8px">
        Recommended fields (your CSV/JSON should include these if possible): <code>brand</code>, <code>generic</code>, <code>api</code>, <code>dosage</code>, <code>form</code>, <code>storage</code>, <code>expiry</code>, <code>side_effects</code>, <code>manufacturer</code>, <code>code</code>, <code>source</code>.
      </div>
      <div style="margin-top:8px">
        <strong>Performance note:</strong> For large datasets (100k+ rows) prepare data as chunked JSON files (e.g., 10k records each) and import them one file at a time. IndexedDB lets you store big datasets without exhausting RAM.
      </div>
    </div>

    <div style="margin-top:10px" class="small muted">
      Official sources for authoritative data: Indian Pharmacopoeia Commission (IP Online), Central Drugs Standard Control Organization (CDSCO) approved drugs lists, and National Pharmaceutical Pricing Authority (NPPA) price lists. See links embedded in the help section below. :contentReference[oaicite:3]{index=3}
    </div>
  </div>

<script>
/* Simple IndexedDB schema:
   DB name: medidb_v1
   store: medicines (keyPath auto-increment)
   each record should include: brand, generic, api, manufacturer, code, expiry, storage, dosage, form, side_effects, source, searchText
*/
const DB_NAME = 'medidb_v1';
const STORE = 'medicines';
let db = null;
let fuse = null;
let lastResults = [];

function openDb() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e) => {
      const idb = e.target.result;
      if (!idb.objectStoreNames.contains(STORE)) {
        const os = idb.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
        os.createIndex('searchText', 'searchText', { unique: false });
        os.createIndex('brand', 'brand', { unique: false });
        os.createIndex('generic', 'generic', { unique: false });
      }
    };
    req.onsuccess = () => { db = req.result; res(db); };
    req.onerror = (e) => rej(e);
  });
}

function addRecords(records, sourceLabel='imported') {
  return new Promise((res, rej) => {
    if (!db) return rej(new Error('DB not opened'));
    const tx = db.transaction(STORE, 'readwrite');
    const os = tx.objectStore(STORE);
    let count = 0;
    for (const r of records) {
      const normalized = normalizeRecord(r);
      normalized.source = normalized.source || sourceLabel;
      normalized.searchText = buildSearchText(normalized);
      os.add(normalized);
      count++;
    }
    tx.oncomplete = () => res(count);
    tx.onerror = (e) => rej(e);
  });
}

function normalizeRecord(r) {
  // keep only typical fields and normalize types
  return {
    brand: r.brand || r.Brand || r.name || r.brand_name || '',
    generic: r.generic || r.Generic || r.salt || '',
    api: r.api || r.API || r.active_ingredient || '',
    dosage: r.dosage || r.Dosage || r.strength || '',
    form: r.form || r.Form || '',
    storage: r.storage || r.Storage || '',
    expiry: r.expiry || r.Expiry || r.shelf_life || '',
    side_effects: r.side_effects || r.sideEffects || r.side_effect || '',
    manufacturer: r.manufacturer || r.Manufacturer || r.mfg || '',
    code: r.code || r.code_no || r.ndc || r.id || '',
    source: r.source || '',
    raw: r // keep original for debugging
  };
}

function buildSearchText(r) {
  return [r.brand, r.generic, r.api, r.manufacturer, r.code, r.form, r.dosage].filter(Boolean).join(' | ').toLowerCase();
}

async function importSelectedFiles(files) {
  if (!files || files.length===0) return;
  document.getElementById('status').textContent = 'Status: importing files...';
  await openDb();
  let total = 0;
  for (const f of files) {
    const txt = await f.text();
    try {
      if (f.name.toLowerCase().endsWith('.json')) {
        const parsed = JSON.parse(txt);
        if (Array.isArray(parsed)) {
          const added = await addRecords(parsed, f.name);
          total += added;
        } else if (parsed.records && Array.isArray(parsed.records)) {
          const added = await addRecords(parsed.records, f.name);
          total += added;
        } else {
          // single object
          const added = await addRecords([parsed], f.name);
          total += added;
        }
      } else if (f.name.toLowerCase().endsWith('.csv')) {
        const parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
        if (parsed && parsed.data) {
          const added = await addRecords(parsed.data, f.name);
          total += added;
        }
      } else {
        console.warn('ignored', f.name);
      }
      document.getElementById('status').textContent = `Imported so far: ${total} records... (processing next file)`;
      // allow UI to update between big files
      await new Promise(r=>setTimeout(r,50));
    } catch (ex) {
      console.error('import err for', f.name, ex);
      alert('Error importing ' + f.name + ': ' + ex.message);
    }
  }
  document.getElementById('status').textContent = `Import complete. Total added: ${total}`;
}

function clearDb() {
  return new Promise(async (res, rej) => {
    await openDb();
    const tx = db.transaction(STORE, 'readwrite');
    const os = tx.objectStore(STORE);
    const req = os.clear();
    req.onsuccess = () => res();
    req.onerror = (e) => rej(e);
  });
}

function searchIndexedDB(q, limit=25) {
  // Simple substring search on precomputed searchText field.
  // For faster fuzzy search, we could build a Fuse index on a small subset or on brand/generic fields once loaded.
  return new Promise(async (res, rej) => {
    q = q.trim().toLowerCase();
    if (!q) return res([]);
    await openDb();
    const tx = db.transaction(STORE, 'readonly');
    const os = tx.objectStore(STORE);
    const req = os.openCursor();
    const out = [];
    req.onsuccess = (e) => {
      const cur = e.target.result;
      if (!cur) { res(out.slice(0, limit)); return; }
      const rec = cur.value;
      if (rec.searchText && rec.searchText.indexOf(q) !== -1) {
        out.push(rec);
      }
      if (out.length >= limit) { res(out.slice(0, limit)); return; }
      cur.continue();
    };
    req.onerror = (e) => rej(e);
  });
}

function renderResults(items) {
  const container = document.getElementById('results');
  container.innerHTML = '';
  if (!items || items.length===0) {
    container.innerHTML = '<div class="small" style="padding:8px">No results</div>';
    return;
  }
  items.forEach(it => {
    const div = document.createElement('div');
    div.className = 'result-item';
    div.innerHTML = `<div style="font-weight:700">${escapeHtml(it.brand || it.generic || '—')}</div>
                     <div class="small">${escapeHtml(it.generic||'')} · ${escapeHtml(it.manufacturer||'')}</div>`;
    div.addEventListener('click', () => showDetail(it));
    container.appendChild(div);
  });
}

function showDetail(rec) {
  document.getElementById('detailTitle').textContent = rec.brand || rec.generic || '—';
  document.getElementById('detailSource').textContent = 'Dataset: ' + (rec.source || 'local');
  document.getElementById('f_brand').textContent = rec.brand || '—';
  document.getElementById('f_generic').textContent = rec.generic || '—';
  document.getElementById('f_api').textContent = rec.api || '—';
  document.getElementById('f_form').textContent = rec.form || '—';
  document.getElementById('f_dosage').textContent = rec.dosage || '—';
  document.getElementById('f_storage').textContent = rec.storage || '—';
  document.getElementById('f_manuf').textContent = rec.manufacturer || '—';
  document.getElementById('f_code').textContent = rec.code || '—';
  document.getElementById('f_expiry').textContent = rec.expiry || '—';
  document.getElementById('f_json').textContent = JSON.stringify(rec.raw || rec, null, 2);
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

document.getElementById('importBtn').addEventListener('click', async () => {
  const files = document.getElementById('fileIn').files;
  if (!files || files.length===0) { alert('Please choose one or more CSV/JSON files to import.'); return; }
  try {
    await importSelectedFiles(files);
  } catch (ex) {
    alert('Import failed: ' + ex.message);
  }
});

document.getElementById('clearDbBtn').addEventListener('click', async () => {
  if (!confirm('Delete all data in local DB? This cannot be undone.')) return;
  await clearDb();
  document.getElementById('status').textContent = 'DB cleared.';
  document.getElementById('results').innerHTML = '';
  document.getElementById('f_json').textContent = '—';
});

document.getElementById('searchBtn').addEventListener('click', async () => {
  const q = document.getElementById('q').value || '';
  if (!q.trim()) { alert('Please enter search text'); return; }
  document.getElementById('status').textContent = 'Searching...';
  const lim = parseInt(document.getElementById('limitSel').value || 25);
  const items = await searchIndexedDB(q, lim);
  renderResults(items);
  document.getElementById('status').textContent = `Search results: ${items.length}`;
});

(function initSample() {
  // small sample to demonstrate UI (not official)
  const sample = [
    {"brand":"Dolo 650","generic":"Paracetamol","api":"Paracetamol 650 mg","manufacturer":"Micro Labs Ltd","dosage":"1 tablet every 4-6 hours","code":"IN-002-DLO","source":"sample"},
    {"brand":"Augmentin 625","generic":"Amoxicillin + Clavulanic acid","api":"Amox 500 mg + Clav 125 mg","manufacturer":"Various","dosage":"1 tablet every 8-12 hours","code":"IN-004-AUG","source":"sample"}
  ];
  // put sample into DB if empty
  openDb().then(() => {
    const tx = db.transaction(STORE,'readonly'); const os = tx.objectStore(STORE); const cntReq = os.count();
    cntReq.onsuccess = () => { if (cntReq.result === 0) { addRecords(sample,'sample').then(c=>document.getElementById('status').textContent='Sample loaded. Import your files to add more.'); } else { document.getElementById('status').textContent='Ready.'; } };
  });
})();
</script>
</body>
</html>
